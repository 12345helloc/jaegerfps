<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Jaeger FPS Demo</title>
<style>
  body { margin:0; overflow:hidden; }
  canvas { display:block; }
  video { display:none; }
</style>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- TensorFlow.js + PoseNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>
</head>
<body>

<script>
let scene, camera, renderer, mixer, clock;
let jaeger, actions = {}, currentAction;
let video, net;

// --- Three.js setup ---
function initThreeJS() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 5;
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    clock = new THREE.Clock();
    console.log("Three.js initialized");
}

renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);
clock = new THREE.Clock();
console.log("Three.js initialized");

// Handle window resize
window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// Light
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 20, 10);
scene.add(light);

// Ambient light for better visibility
const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambientLight);

// Ground
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200, 200),
  new THREE.MeshStandardMaterial({color: 0x222222})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// Load Jaeger/robot model
function loadModel() {
    const loader = new THREE.GLTFLoader();
    loader.load(
        'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/RobotExpressive/glTF/RobotExpressive.glb',
        function(gltf) {
            jaeger = gltf.scene;
            jaeger.scale.set(1, 1, 1);
            scene.add(jaeger);
            jaeger.position.y = 0;
            console.log("Model loaded successfully");

            // Animation mixer
            if(gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(jaeger);
                gltf.animations.forEach(clip => {
                    actions[clip.name] = mixer.clipAction(clip);
                });
                if(actions['Idle']) {
                    currentAction = actions['Idle'];
                    currentAction.play();
                    console.log("Playing Idle animation");
                }
            }

            // Attach camera to head (optional)
            const head = jaeger.getObjectByName("Head");
            if(head) {
                console.log("Head found, attaching camera");
                head.add(camera);
                camera.position.set(0, 0.5, 0);
            } else {
                console.log("Head not found, using default camera position");
            }
        },
        function(progress) {
            console.log("Model loading: " + (progress.loaded / progress.total * 100).toFixed(2) + "%");
        },
        function(error) {
            console.error("Error loading model:", error);
        }
    );
}

// --- Webcam & PoseNet ---
async function setupWebcam(){
    video = document.createElement('video');
    video.width = 640; video.height = 480;
    video.autoplay = true; video.muted = true; video.playsInline = true;
    document.body.appendChild(video);
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    return new Promise(resolve => video.onloadedmetadata = resolve);
}

async function loadPoseNet(){
    try {
        net = await posenet.load();
        console.log("PoseNet loaded");
    } catch(err) {
        console.error("Failed to load PoseNet:", err);
    }
}

// --- Map gestures to animation ---
function updateAnimation(pose){
    const leftWrist = pose.keypoints.find(k=>k.name=='leftWrist');
    const rightWrist = pose.keypoints.find(k=>k.name=='rightWrist');

    if(!leftWrist || !rightWrist) return;

    const lw = leftWrist.position;
    const rw = rightWrist.position;

    // Arms swing -> Walk
    if(Math.abs(lw.y - rw.y) > 50){
        if(currentAction !== actions['Walk']){
            if(currentAction) currentAction.fadeOut(0.2);
            currentAction = actions['Walk'];
            if(currentAction) currentAction.reset().fadeIn(0.2).play();
        }
    } else {
        if(currentAction !== actions['Idle']){
            if(currentAction) currentAction.fadeOut(0.2);
            currentAction = actions['Idle'];
            if(currentAction) currentAction.reset().fadeIn(0.2).play();
        }
    }
}

// --- Animation loop ---
async function animate(){
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    if(mixer) mixer.update(delta);

    if(net && video && video.readyState === 4){
        try {
            const pose = await net.estimateSinglePose(video, {flipHorizontal: true});
            updateAnimation(pose);
        } catch(err) {
            console.error("Pose estimation error:", err);
        }
    }

    renderer.render(scene, camera);
}

// --- Initialize ---
async function init(){
    try {
        console.log("Initializing...");
        initThreeJS();
        loadModel();
        await setupWebcam();
        await loadPoseNet();
        animate();
    } catch(err) {
        console.error("Initialization failed:", err);
    }
}

// Start when page loads
window.addEventListener('load', init);
</script>

</body>
</html>
