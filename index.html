<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Jaeger FPS Demo</title>
<style>
  body { margin:0; overflow:hidden; }
  canvas { display:block; }
  video { display:none; }
</style>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- TensorFlow.js + PoseNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>
</head>
<body>

<script>
let scene, camera, renderer, mixer, clock;
let jaeger, actions = {}, currentAction;
let video, net;

// --- Three.js setup ---
scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);
camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
clock = new THREE.Clock();

// Handle window resize
window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// Light
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,20,10);
scene.add(light);

// Ground
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x222222})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// Load Jaeger/robot model
const loader = new THREE.GLTFLoader();
loader.load('https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/RobotExpressive/glTF/RobotExpressive.glb', function(gltf){
    jaeger = gltf.scene;
    scene.add(jaeger);
    jaeger.position.y = 0;

    // Animation mixer
    mixer = new THREE.AnimationMixer(jaeger);
    gltf.animations.forEach(clip => {
        actions[clip.name] = mixer.clipAction(clip);
    });
    currentAction = actions['Idle'];
    currentAction.play();

    // Attach camera to head
    const head = jaeger.getObjectByName("Head");
    if(head){
        head.add(camera);
        camera.position.set(0,0.5,0);
    }
});

// --- Webcam & PoseNet ---
async function setupWebcam(){
    video = document.createElement('video');
    video.width = 640; video.height = 480;
    video.autoplay = true; video.muted = true; video.playsInline = true;
    document.body.appendChild(video);
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    return new Promise(resolve => video.onloadedmetadata = resolve);
}

async function loadPoseNet(){
    try {
        net = await posenet.load();
        console.log("PoseNet loaded");
    } catch(err) {
        console.error("Failed to load PoseNet:", err);
    }
}

// --- Map gestures to animation ---
function updateAnimation(pose){
    const leftWrist = pose.keypoints.find(k=>k.name=='leftWrist');
    const rightWrist = pose.keypoints.find(k=>k.name=='rightWrist');

    if(!leftWrist || !rightWrist) return;

    const lw = leftWrist.position;
    const rw = rightWrist.position;

    // Arms swing -> Walk
    if(Math.abs(lw.y - rw.y) > 50){
        if(currentAction !== actions['Walk']){
            if(currentAction) currentAction.fadeOut(0.2);
            currentAction = actions['Walk'];
            if(currentAction) currentAction.reset().fadeIn(0.2).play();
        }
    } else {
        if(currentAction !== actions['Idle']){
            if(currentAction) currentAction.fadeOut(0.2);
            currentAction = actions['Idle'];
            if(currentAction) currentAction.reset().fadeIn(0.2).play();
        }
    }
}

// --- Animation loop ---
async function animate(){
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    if(mixer) mixer.update(delta);

    if(net && video.readyState === 4){
        const pose = await net.estimateSinglePose(video,{flipHorizontal:true});
        updateAnimation(pose);
    }

    renderer.render(scene, camera);
}

// --- Initialize ---
async function init(){
    try {
        await setupWebcam();
        await loadPoseNet();
        animate();
    } catch(err) {
        console.error("Initialization failed:", err);
    }
}
init();
</script>

</body>
</html>
